## Update Schedule

 | Graphic | 8 a.m. ET | Note |
 | ------- | ------- | ---- |
 | **U.S Map** | Yes | Data update is automated - please check on the data at 8 a.m. ET |
 | **Topline graphic** | Yes | Requires a republish to show new numbers |
 | **Heatmap Table** | Yes | |
 | **States lookup** | Yes | |
 | **Seamus Page** | Yes | Whenever an update is made |

### U.S. map and the cases/deaths columns of the table

#### How It Works

[A script](https://github.com/nprapps/jhu-interceptor) auto-updates the sheet `_raw_state_data` (and thus the `daily_us_totals` sheet referenced by the map) and [this JSON file](https://apps.npr.org/dailygraphics/data/jhu-covid-19/arcgis.json) **just before 8 a.m. ET.**

The public-facing map and the cases/deaths columns of the table initially render based on the data in the spreadsheet and then update with the data from the JSON. This means that after the data update script runs, these two graphics will automatically display the updated data. A republish is not required (but is still advisable).

On the table, the sort order is based on the numbers in the spreadsheet at the time the graphic was last published â€” not the numbers in the JSON file.

If you want to manually trigger a data update, clone the [JHU-interceptor](https://github.com/nprapps/jhu-interceptor) repo, run it locally and republish the graphic.

#### Update: 8 a.m. ET daily

- Cross-check data in `daily_us_totals` with the [Johns Hopkins dashboard](https://www.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6). It should be up to date, but if there's anything majorly different, (i.e. they've made a big announcement in the last 30 min), you can either [manually trigger](https://github.com/nprapps/jhu-interceptor) a data update or use the `*_override` columns in `daily_us_totals` to override the death and confirmed column for a particular state.
	- **Important:** Clean out the override columns unless you are confident they are actively in use.
	- The overall U.S. total on JHU's site will not match our number exactly because it includes cruise ship passengers and we do not. Better to spot-check cases/deaths in a particular state.
	- Note: On the map, if you want to hide or show a given state's info, use the `label`, `label_offsetX`, `label_offsetY`, `labelSide` columns in `daily_us_totals` to update this.
- Spot check that the numbers show up correctly and consistently in both graphics (map and table).
- In the `labels` sheet, update the time in the `dataAsOf` location, to match the timestamp generated by the data feed. Ignore `dateUpdated` unless you're also updating the heat chart. Note that the map will automatically display a timestamp based on the data feed, but we still want to have a record and a good baseline if the feed falls over.

---------

### Topline stats

#### How It Works

The [topline stats](https://apps.npr.org/dailygraphics/graphics/coronavirus-d3-us-map-20200312/preview.html?preview=topline.html) rely on [county-level timeseries data](https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_time_series) from JHU. The [`_JHU_county_cases`](https://docs.google.com/spreadsheets/d/19BH6v5FGlg_uH1CSVDHFUs6SFDjqbealCsj-ni6EAx0/edit#gid=1605625932) and [`_JHU_county_deaths`](https://docs.google.com/spreadsheets/d/19BH6v5FGlg_uH1CSVDHFUs6SFDjqbealCsj-ni6EAx0/edit#gid=924072138) sheets should be automatically updated via the scraping server. If they're not, clone and run [the scraper](https://github.com/nprapps/jhu-interceptor) locally to update them. You can also do this if they publish a non-scheduled update, and we need to match. The `_jhu_cases_last_7_days` and `_jhu_deaths_last_7_days` sheets aggregate those up to the state/territory level for the last 7 days. (The numbers in the column headers signify numbers of days ago. "Days ago" is relative to the `dateUpdatedCode` specified in the `labels` sheet.) These numbers are then aggregated in the `topline_stats` sheet, which this graphic pulls.

There is a separate iteration of the topline stats display (`topline-newsletter.html`) for potential use in one of NPR's newsletters. They are separate to allow for slightly different styling / content if desired. Whenever this project is republished, the dailygraphics-next rig takes a fallback screenshot based on this graphic. (Defined in `manifest.json`.)

#### Update: 8 a.m. ET daily

- Spot check that the totals look correct. The current case/deaths counts should match the counts in the table. If the one-day numbers are showing up as zeroes, check that the [`_JHU_county_cases`] and [`_JHU_county_deaths`] sheets have data, and that the data columns are cast as numbers.
- Spot check that the last date in each sheet corresponds to the most recent date (the `dateUpdatedCode` in the `labels` sheet).
- The timestamp shown should match the `dataAsOf` in the `labels` sheet (the same timestamp that appears on the map).

----------

### Heatmap table
#### Update: 8 a.m. ET daily

- There should be a **COVID** menu in the toolbar, with a menu item named **"Update state timeline data."** Run this item, and it should create a new column in the `_confirmed_time_raw` sheet. Sanity-check some numbers to make sure they match the `daily_us_totals`, then add a new date value in the top row for your new column (incremented by one).
- In the `labels` sheet, update the date to **yesterday** in the `dateUpdated` field. (The data should be as of the end of the day-ish the previous day.) Don't touch the `dateUpdatedCode` field, which is updated automatically.
- Cross check the graphic to make sure the heatmap looks correct. Individual heatmap blocks have tooltips, for easier spot-checking.

----------

### State lookup

#### How It Works

The [state lookup](https://apps.npr.org/dailygraphics/graphics/coronavirus-d3-us-map-20200312/preview.html?preview=states.html) uses the same data source and update method as the timeline data for the heatmap table. When a new `_confirmed_time_raw` column is created, it updates the `states_confirmed_timeline` sheet and the `states_confirmed_timeline_transposed` sheet. The **lookup** pulls from the `states_confirmed_timeline_transposed` sheet. **Population data for each state** is listed in the `state_populations` sheet and is calculated in the code of the graphic. The **timestamp** pulls from the `dateUpdated` field.

#### Update: 8 a.m. ET daily

- Once the heatmap table data and timestamp are updated, the data and timestamp for the lookup should automatically update as well.
- Spot check the data for individual states or cross-check with `daily_us_totals` to make sure the graphic looks correct and no labels are overlapping. If so, adjust that in the code.
- Check a couple states to see that there's no obvious dips in the lines. JHU frequently publishes daily case counts that are less than the previous day's count. They usually go back and update errors quickly, but our data pipeline doesn't catch those fixes. If there is an error, cross check `_confirmed_time_raw` with their [daily reports](https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/csse_covid_19_daily_reports_us) and manually update the `_confirmed_time_raw` sheet.

----------

### After every update
- Update the story page in Seamus
	- Update the story pubdate. (Right column, under "story settings.")
	- Every couple days, or if there has been a significant jump in numbers in a particular state, update the Seamus promo image. As of April 14, we are using the **state lookup** as the promo image.
		- How to create the promo image: Use the browser inspector to navigate to the `state-lines` class in the graphic, and untoggle the stroke opacity style. Take a screenshot of the chart on the `All States` view. For maximum flexibility when cropping in Seamus, add 500px or so extra of white padding all around in Photoshop before saving the image out for use in Seamus.
	- Republish the page.
- Notify homepage team in the `#homepage` slack channel that the map is updated. Also tag Carmel in the message.

**Redeploy the graphic if you forgot!**

*And you're done!*

----------

## Guide to various sheets

This is documented in the [`_coverpage`](https://docs.google.com/spreadsheets/d/19BH6v5FGlg_uH1CSVDHFUs6SFDjqbealCsj-ni6EAx0/edit#gid=1095201758) sheet.

## Possible improvements
- abstract all data collection to separate workbook
- indiscrete scale for the colors of the chart?
- Update the heatmap to use the aggregated data used by the topline table, rather than the add-on script.
- The topline graphic does not deal well right now with overrides. Is there somewhere to centralize where/how this is calculated?
